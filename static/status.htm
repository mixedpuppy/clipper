<html>
<head>
  <title>DemoSocialService</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/carousel.css" rel="stylesheet">
  <script src="js/jquery-1.11.1.min.js" type="application/javascript"></script>
  <script src="js/jquery.mustache.js" type="application/javascript"></script>
  <script src="js/jquery.cycle2.min.js" type="application/javascript"></script>
  <script src="js/jquery.cycle2.center.js" type="application/javascript"></script>
  <script src="js/jquery.cycle2.center.js" type="application/javascript"></script>
  <script src="js/remotestorage.js" type="application/javascript"></script>
  <script src="js/ebayapi.js" type="application/javascript"></script>
  <script src="js/storage.js" type="application/javascript"></script>
  <script src="js/site.js" type="text/javascript"></script>

  <script type="text/javascript">
  $(document).ready(function() {
    remoteStorage.access.claim('clips', 'rw');
    remoteStorage.clips.init();
  });


  function socialMarkUpdate(isMarked) {
    try {
    var evt = document.createEvent("CustomEvent");
    evt.initCustomEvent("socialMarkUpdate", true, true, JSON.stringify({marked: isMarked}));
    document.documentElement.dispatchEvent(evt);
    } catch(e) {
        dump("****** unable to send socialMarkUpdate "+e+"\n");
    }
  }
  var shareData, previews = {};

  function handleOpenGraphData() {
    if (!shareData.siteName) {
      shareData.siteName = parseUrl(shareData.url).host;
    }
    $("#site-detail").empty();
    $("#site-detail").html($("#site-detail-tmpl").mustache(shareData));
    //setData(shareData);
    //console.log(shareData);

    getSiteData(shareData, function() {
      previews = getPreviewsFromData(shareData);
      $(".carousel").toggleClass("loading");
      var previewData = [previews[d] for (d in previews)];
      console.log("preview images "+previewData.length);
      if (previewData.length < 2) {
        $(".carousel-inner span").hide();
      }
      if (previewData.length < 1) {
        $(".carousel").toggleClass("noimage");
      }
      $("#carousel-chooser").append($("#product-detail-tmpl").mustache({list: previewData}));
      $('#carousel-chooser').cycle();
    });
  }

  addEventListener("OpenGraphData", function(e) {
    shareData = JSON.parse(e.detail);
    handleOpenGraphData();
  });
  
  function saveMark() {
    // get the choosen item
    var image = $(".cycle-slide-active").attr("image");
    shareData.data = previews[image];
    $("#content").addClass("saving");

    // store into localstorage, and set the mark
    //var items = localStorage["cart-add"];
    //if (items) {
    //  items = JSON.parse(items);
    //} else {
    //  items = [];
    //}
    //items.push(shareData);
    //localStorage["cart-add"] = JSON.stringify(items);
    //$("#content").toggleClass("saving");
    //$("#content").toggleClass("saved");
    //window.setTimeout(function() { window.close() }, 1000);
    
    remoteStorage.clips.add(shareData).then(function() {
      socialMarkUpdate(true);
    
      $("#content").toggleClass("saving");
      $("#content").addClass("saved");
      localStorage["refresh"] = true;
      window.setTimeout(function() { window.close() }, 1000);
    });
  }
  
  function toggleHidden(e) {
    if (e.style.display == "none") {
      e.style.display = "block";
    } else {
      e.style.display = "none";
    }
  }
  function showData() {
    window.open("data:application/json;charset=utf8,"+encodeURIComponent(JSON.stringify(shareData)));
  }
  </script>


</head>
<body contentid="content">
  <div id="content" style="margin: 0px; padding: 0; min-height: 300px;">
    <div id="product-detail" class="clearfix">
      <div id="carousel-promotions" class="carousel loading">
        <div class="carousel-wrapper">
          <div id="carousel-chooser" class="carousel-inner"
            data-cycle-center-horz="true"
            data-cycle-center-vert="true"
            data-cycle-auto-height="calc"
            data-cycle-pager=".cycle-pager"
            data-cycle-prev=".cycle-prev"
            data-cycle-next=".cycle-next"
            data-cycle-fx="scrollHorz"
            data-cycle-paused="true"
            data-cycle-slides="&gt; div">
            <span class="cycle-prev"><div class="circle">&lsaquo;</div></span>
            <span class="cycle-next"><div class="circle">&rsaquo;</div></span>
          </div>
        </div>
      </div>
      <div id="site-detail"></div>

      <div id="message">
        <h1 class="label label-success"><img src="/images/clipper.png" width="64" height="64"/>Saved!</h1>
        <h1 class="label label-info"><img src="/images/clipper.png" width="64" height="64"/>Saving...</h1>
        <h1 class="label label-danger"><img src="/images/clipper.png" width="64" height="64"/>Error occured wile saving.</h1>
      </div>
    </div>

    <div id="buttons">
      <span type="button" class="btn btn-default glyphicon scissors" onclick="saveMark();" alt="Save"></span>
      <span type="button" class="btn btn-default glyphicon glyphicon-eye-open" href="./" onclick="window.open(this.getAttribute('href'),'clipperCart').focus(); return false;" als="View Cart"></span>
      <span type="button" class="btn btn-default glyphicon glyphicon-wrench" onclick="showData();" alt="View Data"></span>
      <span type="button" class="btn btn-default glyphicon glyphicon-remove" onclick="window.close();" alt="Close"></span>
    </div>

    <div class="clearfix"></div>
  </div>


<script id="site-detail-tmpl" type="text/x-jquery-tmpl">
  {{#siteName}}
  <div class="site-detail">
    <span>{{siteName}}</span>
  </div>
  {{/siteName}}
</script>

<script id="page-detail-tmpl" type="text/x-jquery-tmpl">
  <div class="item preview" data-data='{{data}}' style='background-image: url("{{image}}");'>
    <div class="details">
    <p class="lead">{{name}}</p>
    </div>
  </div>
</script>

<script id="product-detail-tmpl" type="text/x-jquery-tmpl">
  {{#list}}
  <div class="item product" style='background-image: url("{{image}}");' image="{{image}}">
    <div class="details">
    <span class="lead">{{name}}</span><br/>
    {{#price}}<span>{{.}}</span>{{/price}}
    </div>
  </div>
  {{/list}}
</script>

</body>
</html>
