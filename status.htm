<html>
<head>
  <title>DemoSocialService</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/carousel.css" rel="stylesheet">
  <script src="js/jquery-1.11.1.min.js" type="application/javascript"></script>
  <script src="js/jquery.mustache.js" type="application/javascript"></script>
  <script src="js/jquery.cycle2.min.js" type="application/javascript"></script>
  <script src="js/jquery.cycle2.center.js" type="application/javascript"></script>

  <script>
  function socialMarkUpdate(isMarked) {
    try {
    var evt = document.createEvent("CustomEvent");
    evt.initCustomEvent("socialMarkUpdate", true, true, JSON.stringify({marked: isMarked}));
    document.documentElement.dispatchEvent(evt);
    } catch(e) {
        dump("****** unable to send socialMarkUpdate "+e+"\n");
    }
  }
  var shareData;
  function setData(data) {
    //dump("******** got OpenGraphData event! "+data+"\n");
    shareData = JSON.parse(data);
    $("#shared").text(shareData.url);
    $("#data").text(data);
    $("#site-detail").empty();
    $("#site-detail").html($("#site-detail-tmpl").mustache(shareData));
    var previews = {};

    if (shareData.microdata && shareData.microdata.items.length) {
      for (var i in shareData.microdata.items) {
        var item = shareData.microdata.items[i];
        var properties = item.properties;
        if (!properties.url)
          properties.url = shareData.url;
        var d = {
          data: JSON.stringify(item)
        };
        if (item.types.indexOf("http://schema.org/Product") >= 0) {
          if (properties.name) {
            d.name = properties.name;
          }
          if (properties.image) {
            d.image = properties.image;
          }
          if (properties.offers && properties.offers.length) {
            d.price = properties.offers[0].properties.price;
          }
        } else
        if (types.indexOf("http://data-vocabulary.org/Product") >= 0) {
          if (properties.name) {
            d.name = properties.name;
          }
          if (properties.image) {
            d.image = properties.image;
          }
          if (properties.offerDetails && properties.offerDetails.length) {
            d.price = properties.offerDetails[0].properties.price;
          }
        }
        previews[d.image] = d;
        //$("#carousel-chooser").append($("#product-detail-tmpl").mustache(d));
      }
    }
    
    if (shareData.previews) {
      for (var i in shareData.previews) {
        if (!shareData.previews[i])
          continue;
        var d = {
          name: shareData.title,
          url: shareData.url,
          image: shareData.previews[i]
        };
        previews[d.image] = d;
        //$("#carousel-chooser").append($("#page-detail-tmpl").mustache(d));
      }
    }
    if (shareData["og:image"]) {
      var d = {
        name: shareData.title,
        url: shareData.url,
        image: shareData["og:image"]
      };
      previews[d.image] = d;
      //$("#carousel-chooser").append($("#page-detail-tmpl").mustache(d));
    }

    var previewData = [previews[d] for (d in previews)];
    $("#carousel-chooser").append($("#product-detail-tmpl").mustache({list: previewData}));
    $('#carousel-chooser').cycle();
  }
  addEventListener("OpenGraphData", function(e) {
    setData(e.detail);
  });
  
  function saveMark() {
    // store into localstorage, and set the mark
    var items = localStorage["cart"];
    if (items) {
      items = JSON.parse(items);
    } else {
      items = [];
    }
    items.push(shareData);
    localStorage["cart"] = JSON.stringify(items);
    socialMarkUpdate(true);
  }
  
  function toggleHidden(e) {
    if (e.style.display == "none") {
      e.style.display = "block";
    } else {
      e.style.display = "none";
    }
  }
  function showData() {
    toggleHidden(document.getElementById("product-detail"));
    toggleHidden(document.getElementById("debug-data"));
  }
  </script>


</head>
<body contentid="content">
  <div id="content" style="margin: 0px; padding: 10px; min-height: 300px;">

  <div id="product-detail" class="clearfix">
  <div id="site-detail"></div>
  <div id="carousel-promotions" class="carousel">
    <div class="carousel-wrapper">
      <div id="carousel-chooser" class="carousel-inner"
        data-cycle-center-horz="true"
        data-cycle-center-vert="true"
        data-cycle-auto-height="calc"
        data-cycle-pager=".cycle-pager"
        data-cycle-prev=".cycle-prev"
        data-cycle-next=".cycle-next"
        data-cycle-fx="scrollHorz"
        data-cycle-paused="true"
        data-cycle-slides="&gt; div">
      </div>
      <div class="clearfix">
        <span class="cycle-prev center">&lsaquo;</span>
        <div class="cycle-pager center"></div>
        <span class="cycle-next center">&rsaquo;</span>
      </div>
    </div>
  </div>
    
  </div>

  <div id="buttons">
  <span type="button" class="btn btn-default" onclick="saveMark();">Save</span>
  <span type="button" class="btn btn-default" href="./" onclick="window.open(this.getAttribute('href'),'clipperCart').focus(); return false;">View Cart</span>
  <span type="button" class="btn btn-default" onclick="showData();">Show Data</span>
  </div>
<div id="debug-data" style="display: none;" class="clearfix">
  <div>Page Marked: <div id="shared" class="textbox"></div></div>
  <div>Data: <div id="data" class="textbox"></div></div>
</div>

<script id="site-detail-tmpl" type="text/x-jquery-tmpl">
  <div>
    <p><a href="{{url}}" target="_blank" alt="{{url}}">{{siteName}}</a> {{title}}</p>
  </div>
</script>

<script id="page-detail-tmpl" type="text/x-jquery-tmpl">
  <div class="item preview" data-data='{{data}}' style='background-image: url("{{image}}");'>
    <div class="details">
    <p class="lead">{{name}}</p>
    </div>
  </div>
</script>

<script id="product-detail-tmpl" type="text/x-jquery-tmpl">
  {{#list}}
  <div class="item product" {{#data}}data-data='{{.}}'{{/data}} style='background-image: url("{{image}}");'>
    <div class="details">
    <span class="lead">{{name}}</span><br/>
    {{#price}}<span>{{.}}</span>{{/price}}
    {{#description}}<span>{{.}}</span>{{/description}}
    </div>
  </div>
  {{/list}}
</script>

</body>
</html>
